/* do this first to validate everything is ok */
   
go:-
  % broker:start,
  rli_start_server(broker),
  for(I,1,3),
    launch(I),
  fail
; for(I,1,3),
    bg(rli_out(broker,ready_token)),
  fail
; sleep(2),
  map(rli_hi,[agent1,agent2,agent3]),
  writeln(all_started).
  
launch(1):- % NEW
  ClassName=agent_class1,
  WinName='Event Source Window',
  AgentName=agent1,
  Goal=event_source(agent1),
  launch_ssoa(ClassName,WinName,AgentName,Goal).
launch(2):-launch_ssoa(agent2,'A Target Window',event_target(agent2)).
launch(3):-launch_ssoa(agent3,'Another Target Windows',event_target(agent3)).

launch_ssoa(Name,Goal):-AgentClass=Name,launch_ssoa(AgentClass,Name,Goal).

launch_ssoa(AgentClass,WinName,Goal):-launch_ssoa(AgentClass,WinName,AgentClass,Goal).

%launch_ssoa(AgentClass,WinName,AgentName,Goal):-acmd(Goal,AgentClass,WinName,AgentName). % NEW
launch_ssoa(AgentClass,WinName,AgentName,Goal):-icmd(Goal,AgentClass,WinName,AgentName).

icmd(Goal,AgentClass,WinName,AgentName):-
  AgentConstructor=..[AgentClass,WinName,Goal,AgentName],
  bg(new(AgentConstructor,_A)).
  
acmd(Goal,AgentClass,WinName,AgentName):-
  acmd(Goal,AgentClass,WinName,AgentName,Cmd),
  bg(vivo_process(Cmd)).

acmd(Goal,AgentClass,WinName,Cmd)-acmd(Goal,AgentClass,WinName,AgentClass,Cmd).

acmd(Goal,AgentClass,WinName,AgentName,Cmd):-
  AgentConstructor=..[AgentClass,WinName,Goal,AgentName],
  and(new(AgentConstructor,T),T:vivo_wait)=Cmd.

%vivo_process(Arg):-external_vivo_process(java,Arg). % use this for debugging
vivo_process(Arg):-external_vivo_process(javaw,Arg). % use this for deployment

external_vivo_process(Java,Arg):-
   to_string(Arg,SArg),
   make_cmd([
   'cmd /c start ',
   Java,' ',
   '-Djava.rmi.server.codebase=file:/bin/prolog.jar -Xmx512M ',
   '-classpath ".;/bin/prolog.jar;/bin/prolog2d.jar;/bin/prolog3d.jar" ',
   'prolog.kernel.Main "/bin/prolog.jar" "',
   SArg,'"'],
   Cmd),
   writeln(cmd=Cmd),
   system(Cmd).

stop_all:-
  foreach(
    member(A,[agent1,agent2,agent3]),
    stop_ssoa(A)
  ),
  rli_call(broker,agent_stop),
  halt.
  
stop_ssoa(Name):-rli_call(Name,vivo_stop).
