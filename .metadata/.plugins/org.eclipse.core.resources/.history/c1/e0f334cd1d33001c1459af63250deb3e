:-[gui_agent].

slowness(0). % time between steps in ms

maxsteps(1000).

vivo_agent(Goal,Port):-vivo_agent(Port,Goal,Port). 

vivo_agent(WinName,Goal,Port):-
  finished<=no,
  gui_agent(new_console,WinName,Port,Goal).

vivo_wait:-sleep(200000),halt.

vivo_stop:-
  finished<=yes,
  bg(and(sleep(1),halt)).

out_mes(From,To,Mes):-rli_out(To,mes(From,Mes)).

in_mes(From,To,Mes):-rli_in(To,mes(From,Mes)).

event_source(Self):-
  writeln(starting_source(Self)),
  rli_in(broker,ready_token),
  writeln(source_ready(Self)), 
  maxsteps(Max),
  slowness(MS),
  for(I,1,Max),
    sleep_ms(MS),
    writeln(sent(agent2,event(I))),
    fg(out_mes(Self,agent2,event(I))),
    writeln(sent(agent3,event(I))),
    fg(out_mes(Self,agent3,event(I))),
  fail.
event_source(Self):-writeln(source_finished(Self)).

fg(Goal):-Goal.
  
event_target(Self):-
  writeln(starting_target(Self)),nl,
  rli_in(broker,ready_token),
  writeln(target_ready(Self)), 
  maxsteps(Max),
  for(_,1,Max),
    fg(
     and(
      in_mes(agent1,Self,Mes),
      writeln(received=Mes),
      nl
     )
    ),
  fail.
event_target(Self):-writeln(target_finished(Self)).  

